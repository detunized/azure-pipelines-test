trigger:
  branches:
    include:
    - master
  tags:
    include:
    - v*

jobs:

- job: libfido2_windows
  pool:
    vmImage: windows-2019

  steps:
  - script: 'git clone --branch 1.2.0 --depth 1 https://github.com/Yubico/libfido2.git'
  - script: 'cd libfido2\windows && .\build.ps1'

#
# Windows
#

- job: Windows
  pool:
    vmImage: 'ubuntu-latest'

  # Disable for now
  condition: false

  variables:
    framework: 'netcoreapp3.0'
    solution: 'password-manager-access.sln'
    buildPlatform: 'Any CPU'
    buildConfiguration: 'Release'

  steps:
  - bash: "dotnet build -c Release sol.sln"
    displayName: Build

  - bash: "dotnet test --no-build -c Release --logger trx sol.sln"
    displayName: Test

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: VSTest
      testResultsFiles: test/TestResults/*.trx

  - publish: .
    artifact: package-windows

#
# Linux
#

- job: Linux
  pool:
    vmImage: 'ubuntu-latest'

  # Disable for now
  condition: false

  variables:
    framework: 'netcoreapp3.0'
    solution: 'password-manager-access.sln'
    buildPlatform: 'Any CPU'
    buildConfiguration: 'Release'

  steps:
  - bash: 'compgen -c | sort'
    displayName: 'compgen'

  - bash: 'env'
    displayName: 'env'

  - bash: 'echo yo > test.txt'
    displayName: 'make test file'

  - publish: .
    artifact: package-linux

#
# Release to GitHub
#

- job: Release

  dependsOn:
  - Windows
  - Linux

  condition: startsWith(variables['build.sourceBranch'], 'refs/tags/v')

  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: none

  - download: current
    artifact: package-linux

  - bash: 'ls -lR $(Pipeline.Workspace)'
    displayName: 'ls workspace'

  - task: GitHubRelease@0
    inputs:
      gitHubConnection: github-release
      assets: $(Pipeline.Workspace)/**/*.txt
      tagSource: manual
      tag: $(Build.SourceBranchName)
